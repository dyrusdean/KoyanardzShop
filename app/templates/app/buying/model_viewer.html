{% extends 'app/navigation.html' %}
{% load static %}
{% load humanize %}

{% block content %}

<style>
  body { margin: 0; background: #f5f5f5; }
  canvas { display: block; }
  h2 { text-align: center; padding: 12px; }
</style>

<h2>Your 3D Build Preview</h2>

<div id="viewer-container" style="width:100%; height:80vh;"></div>
<div id="builder-actions" 
     style="width: 100%; padding: 20px; display: flex; justify-content: center;">

  <div style="
      background: white; 
      padding: 20px; 
      border-radius: 14px; 
      box-shadow: 0 2px 12px rgba(0,0,0,0.15);
      width: 500px;
      text-align: center;">

    <h3>Your Build Summary</h3>

    <p id="build-total" style="font-size: 22px; font-weight: bold; margin-bottom: 16px;">
      Total: ₱33787
    </p>

    <form id="addBuildToCartForm" method="POST" action="{% url 'add_pc_build' %}">
      {% csrf_token %}
        <input type="hidden" name="build_json" id="buildJsonInput">
        <button type="submit" style="background:#0D6EFD; color:white; padding:12px 20px; border:none; border-radius:10px; width:100%; font-size:16px;">
          Add Build to Cart
        </button>
    </form>

    <a href="{% url 'checkout' %}" id="checkoutBtn" style="
        display:block;
        margin-top:10px;
        background:#198754;
        color:white;
        padding:12px 20px;
        border-radius:10px;
        width:100%;
        font-size:16px;
        text-align:center;
        text-decoration:none;">
        Proceed to Checkout
    </a>
</div>


</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.147.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.147.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.147.0/examples/js/loaders/GLTFLoader.js"></script>

<script>
window.addEventListener('DOMContentLoaded', () => {
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0xf5f5f5);

  const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
  camera.position.set(2, 2, 3); // mas okay ang distance dito para makita lahat ng parts

  const renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.getElementById('viewer-container').appendChild(renderer.domElement);

  const controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.1;

  const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 1.2);
  hemiLight.position.set(0, 2, 0);
  scene.add(hemiLight);

  const dirLight = new THREE.DirectionalLight(0xffffff, 1);
  dirLight.position.set(3, 10, 10);
  scene.add(dirLight);

  const loader = new THREE.GLTFLoader();

  const parts = [
    { file: "{% static 'images/3D/case_black.glb' %}", target: { x: 0.3, y: 0, z: 0 }, isCase: true },
    { file: "{% static 'images/3D/motherboard.glb' %}", target: { x: 0, y: 0.1, z: 0 }, isCase: false },
    { file: "{% static 'images/3D/cpu.glb' %}", target: { x: 0.02, y: 0.5, z: 0 }, isCase: false },
    { file: "{% static 'images/3D/ram.glb' %}", target: { x: 0.05, y: 0.2, z: 0 }, isCase: false },
    { file: "{% static 'images/3D/gpu.glb' %}", target: { x: 0.05, y: 0.15, z: 0 }, isCase: false },
    { file: "{% static 'images/3D/fan_large.glb' %}", target: { x: 0.10, y: 0.35, z: 0 }, isCase: false }
  ];

  let animatedParts = [];
  let allLoaded = 0;

  parts.forEach(part => {
    loader.load(
      part.file,
      gltf => {
        const model = gltf.scene;

        // Auto-scale
        const box = new THREE.Box3().setFromObject(model);
        const size = box.getSize(new THREE.Vector3());
        const maxDim = Math.max(size.x, size.y, size.z);
        const targetSize = part.isCase ? 1.2 : 0.4;
        const scale = targetSize / maxDim;
        model.scale.set(scale, scale, scale);

        // Scatter initial position - smaller range para hindi masyadong malayo
        const scatterRange = 2.5;
        model.position.set(
          (Math.random() - 0.5) * scatterRange,
          (Math.random() - 0.5) * scatterRange,
          (Math.random() - 0.5) * scatterRange
        );

        scene.add(model);
        animatedParts.push({ model: model, target: new THREE.Vector3(part.target.x, part.target.y, part.target.z), fused: false });

        allLoaded++;
        if (allLoaded === parts.length) {
          console.log('All parts loaded, starting animation');
        }
      },
      undefined,
      error => console.error('Error loading:', part.file, error)
    );
  });

  let fusionComplete = false;

  function animate() {
    requestAnimationFrame(animate);

    if (!fusionComplete && animatedParts.length === parts.length) {
      fusionComplete = true;

      animatedParts.forEach(p => {
        if (!p.fused) {
          // Move model closer to target position (lerp smooth movement)
          p.model.position.lerp(p.target, 0.015);

          // Optional rotation during fusion
          p.model.rotation.x += 0.01;
          p.model.rotation.y += 0.01;

          const dist = p.model.position.distanceTo(p.target);
          if (dist > 0.01) fusionComplete = false;
          else {
            p.model.position.copy(p.target);
            p.fused = true;

            // Stop rotation exactly when fused
            p.model.rotation.x = 0;
            p.model.rotation.y = 0;
          }
        }
      });
    }

    controls.update();
    renderer.render(scene, camera);
  }

  animate();

  window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });
});
  
const params = new URLSearchParams(window.location.search);

const selectedIds = params.get("product_ids")
  ? params.get("product_ids").split(",").map(id => id.trim())
  : [];

const totalPrice = params.get("total_price") || 0;

document.getElementById("build-total").innerText =
  "Total: ₱" + Number(totalPrice || 0).toLocaleString();

document.getElementById("addBuildToCartForm").addEventListener("submit", function(e) {
    e.preventDefault(); 

    const buildData = window.selectedBuildComponents || {};
    
    fetch("{% url 'add_pc_build' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({
            parts: Object.values(buildData).map(part => ({
                id: part.id,
                quantity: 1
            }))
        })
    })
    .then(res => res.json())
    .then(data => {
        alert("Build added to cart!");
        console.log(data);
    })
    .catch(err => console.error(err));
});

</script>

{% endblock content %}
