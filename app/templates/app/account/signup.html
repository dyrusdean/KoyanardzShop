{% extends 'app/navigation.html' %}
{% load static %}

{% block content %}

<script>
    // Load Firebase signup handler with module support
    function loadFirebaseSignup() {
        const script = document.createElement('script');
        script.type = 'module';
        script.src = "{% static 'js/firebase-signup.js' %}";
        script.onload = () => {
            console.log('Firebase signup script loaded');
        };
        script.onerror = (e) => {
            console.error('Failed to load firebase-signup.js', e);
        };
        document.head.appendChild(script);
    }
    
    // Load it when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadFirebaseSignup);
    } else {
        loadFirebaseSignup();
    }

    function togglePasswordVisibility(button) {
        event.preventDefault();
        const input = button.previousElementSibling;
        const icon = button.querySelector('i');
        
        if (!input || !icon) return;
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {    
            input.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }

    function togglePasswordField(img) {
        const wrapper = img.parentElement;
        const input = wrapper.querySelector('input');
        
        if (!input) return;
        
        if (input.type === 'password') {
            input.type = 'text';
            img.src = "{% static 'images/icon/password-visible.png' %}";
        } else {
            input.type = 'password';
            img.src = "{% static 'images/icon/password-hide.png' %}";
        }
    }

    function startOTPCountdown() {
        console.log('startOTPCountdown called');
        
        const otpInput = document.querySelector('input[name="otp_code"]');
        const resendBtn = document.getElementById('resend-btn');
        const cooldownDisplay = document.getElementById('resend-cooldown');
        const otpTimerDisplay = document.getElementById('otp-timer');
        
        console.log('Elements found in startOTPCountdown:', { otpInput, resendBtn, cooldownDisplay, otpTimerDisplay });
        
        // If otp timer display not found, we can't start the timer
        if (!otpTimerDisplay) {
            console.error('OTP timer element not found!');
            return false;
        }
        
        // OTP input formatting - allow numbers and letters (for hex codes)
        if (otpInput) {
            otpInput.addEventListener('input', function() {
                this.value = this.value.replace(/[^0-9a-zA-Z]/gi, '');
            });
        }
        
        // Check if OTP timer was already started (from localStorage)
        let otpExpiresAt = localStorage.getItem('otpExpiresAt');
        let resendCooldownEnd = localStorage.getItem('resendCooldownEnd');
        
        // OTP validity timer (5 minutes from first load)
        if (!otpExpiresAt) {
            otpExpiresAt = new Date(new Date().getTime() + 5 * 60 * 1000).getTime();
            localStorage.setItem('otpExpiresAt', otpExpiresAt);
            console.log('Created new OTP timer, expires at:', new Date(otpExpiresAt));
        } else {
            otpExpiresAt = parseInt(otpExpiresAt);
            console.log('Using existing OTP timer, expires at:', new Date(otpExpiresAt));
        }

        const otpCountdown = setInterval(() => {
            const otpTimer = document.getElementById('otp-timer');
            if (!otpTimer) {
                clearInterval(otpCountdown);
                return;
            }
            const now = new Date().getTime();
            const distance = otpExpiresAt - now;

            if (distance <= 0) {
                clearInterval(otpCountdown);
                otpTimer.textContent = '⚠ OTP expired. Please request a new code.';
                otpTimer.style.color = '#c33';
                localStorage.removeItem('otpExpiresAt');
                return;
            }

            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            otpTimer.textContent = `⏱ OTP expires in ${minutes}m ${seconds}s`;
            otpTimer.style.color = '#003d99';
        }, 1000);
        
        // Force immediate display update
        const now = new Date().getTime();
        const initialDistance = otpExpiresAt - now;
        if (initialDistance > 0) {
            const minutes = Math.floor((initialDistance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((initialDistance % (1000 * 60)) / 1000);
            otpTimerDisplay.textContent = `⏱ OTP expires in ${minutes}m ${seconds}s`;
            otpTimerDisplay.style.color = '#003d99';
        }

        // Resend cooldown (1 minute from first attempt)
        if (!resendCooldownEnd) {
            resendCooldownEnd = new Date(new Date().getTime() + 60 * 1000).getTime();
            localStorage.setItem('resendCooldownEnd', resendCooldownEnd);
            console.log('Created new resend cooldown, ends at:', new Date(resendCooldownEnd));
        } else {
            resendCooldownEnd = parseInt(resendCooldownEnd);
            console.log('Using existing resend cooldown, ends at:', new Date(resendCooldownEnd));
        }
        
        // Disable resend button initially
        if (resendBtn) {
            resendBtn.disabled = true;
            resendBtn.style.opacity = '0.6';
            resendBtn.style.cursor = 'not-allowed';
        }
        
        // Force initial update for cooldown display
        const cooldownNow = new Date().getTime();
        const cooldownInitialDistance = resendCooldownEnd - cooldownNow;
        if (cooldownDisplay && cooldownInitialDistance > 0) {
            const initialSeconds = Math.ceil(cooldownInitialDistance / 1000);
            cooldownDisplay.textContent = `You can resend in ${initialSeconds}s`;
            cooldownDisplay.style.display = 'block';
        }
        
        const countdown = setInterval(() => {
            const cooldownEl = document.getElementById('resend-cooldown');
            const resendBtnEl = document.getElementById('resend-btn');
            const now = new Date().getTime();
            const resendDistance = resendCooldownEnd - now;
            
            // Resend Cooldown Timer
            if (resendDistance > 0) {
                const resendSeconds = Math.ceil(resendDistance / 1000);
                if (cooldownEl) {
                    cooldownEl.textContent = `You can resend in ${resendSeconds}s`;
                    cooldownEl.style.display = 'block';
                }
            } else {
                clearInterval(countdown);
                if (cooldownEl) {
                    cooldownEl.textContent = 'Ready to resend';
                    cooldownEl.style.display = 'block';
                }
                if (resendBtnEl) {
                    resendBtnEl.disabled = false;
                    resendBtnEl.style.opacity = '1';
                    resendBtnEl.style.cursor = 'pointer';
                }
                localStorage.removeItem('resendCooldownEnd');
            }
        }, 1000);
        
        return true;
    }

    function handleResendClick(e) {
        e.preventDefault();
        console.log('Resend click triggered');
        
        const resendBtn = document.getElementById('resend-btn');
        let resendForm = document.getElementById('resend-otp-form');
        let cooldownDisplay = document.getElementById('resend-cooldown');
        
        console.log('Initial elements found:', { resendBtn, resendForm, cooldownDisplay });
        
        // Check the button exists
        if (!resendBtn) {
            console.error('Missing resend button element (id="resend-btn")');
            alert('Error: Resend button not found.');
            return;
        }
        
        // Fallback: if form not found by ID, try to find it from button's parent
        if (!resendForm) {
            console.warn('Form not found by ID, searching parent elements');
            resendForm = resendBtn.closest('form');
            console.log('Form found via closest():', resendForm);
        }
        
        // Final check - if still no form, create a new request object
        if (!resendForm) {
            console.warn('Form still not found, will construct manual request');
        }
        
        // Create cooldown display if it doesn't exist
        if (!cooldownDisplay) {
            console.warn('Cooldown display not found, creating one');
            cooldownDisplay = document.createElement('div');
            cooldownDisplay.id = 'resend-cooldown';
            cooldownDisplay.className = 'resend-cooldown-text';
            resendBtn.parentElement.insertBefore(cooldownDisplay, resendBtn);
        }
        
        // Disable button immediately
        resendBtn.disabled = true;
        resendBtn.style.opacity = '0.6';
        resendBtn.style.cursor = 'not-allowed';
        const originalText = resendBtn.textContent;
        resendBtn.textContent = 'Sending...';
        
        console.log('Button disabled, preparing to send request');
        
        // Get form data
        let csrfToken = null;
        let otpEmail = null;
        
        if (resendForm) {
            const formData = new FormData(resendForm);
            csrfToken = formData.get('csrfmiddlewaretoken');
            otpEmail = formData.get('otp_email');
            console.log('Got data from form:', { csrfToken: csrfToken ? 'present' : 'missing', otpEmail });
        } else {
            // Fallback: try to find CSRF token and email from page
            const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
            const emailInput = document.querySelector('input[name="otp_email"]');
            csrfToken = csrfInput ? csrfInput.value : null;
            otpEmail = emailInput ? emailInput.value : null;
            console.log('Got data from document:', { csrfToken: csrfToken ? 'present' : 'missing', otpEmail });
        }
        
        if (!csrfToken) {
            console.error('Missing CSRF token');
            alert('Error: CSRF token not found. Please refresh the page.');
            resendBtn.disabled = false;
            resendBtn.style.opacity = '1';
            resendBtn.style.cursor = 'pointer';
            resendBtn.textContent = originalText;
            return;
        }
        
        if (!otpEmail) {
            console.error('Missing OTP email');
            alert('Error: Email not found. Please refresh the page.');
            resendBtn.disabled = false;
            resendBtn.style.opacity = '1';
            resendBtn.style.cursor = 'pointer';
            resendBtn.textContent = originalText;
            return;
        }
        
        console.log('Sending request with:', { csrfToken: 'present', otpEmail });
        
        // Use fetch to send the resend request
        fetch('{% url "resend-otp" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `csrfmiddlewaretoken=${encodeURIComponent(csrfToken)}&otp_email=${encodeURIComponent(otpEmail)}`
        })
        .then(response => {
            console.log('Response status:', response.status);
            console.log('Response:', response);
            
            if (response.ok) {
                // Success - show message
                cooldownDisplay.innerHTML = '<span style="color: #4caf50; font-weight: bold;">✓ New code sent! Check your email.</span>';
                resendBtn.textContent = originalText;
                
                // Reset OTP timer - new code means new 5 minute timer
                const newOtpExpiresAt = new Date(new Date().getTime() + 5 * 60 * 1000).getTime();
                localStorage.setItem('otpExpiresAt', newOtpExpiresAt);
                console.log('OTP timer reset. New expiration at:', new Date(newOtpExpiresAt));
                
                // Clear and restart resend cooldown from now
                localStorage.removeItem('resendCooldownEnd');
                const newCooldownEnd = new Date(new Date().getTime() + 60 * 1000).getTime();
                localStorage.setItem('resendCooldownEnd', newCooldownEnd);
                
                // Start 60 second cooldown
                const cooldownEnd = newCooldownEnd;
                
                const cooldownTimer = setInterval(() => {
                    const now = new Date().getTime();
                    const distance = cooldownEnd - now;
                    
                    if (distance <= 0) {
                        clearInterval(cooldownTimer);
                        cooldownDisplay.innerHTML = '<span style="color: #666;">Ready to resend</span>';
                        resendBtn.disabled = false;
                        resendBtn.style.opacity = '1';
                        resendBtn.style.cursor = 'pointer';
                        localStorage.removeItem('resendCooldownEnd');
                        console.log('Cooldown complete, button re-enabled');
                        return;
                    }
                    
                    const seconds = Math.floor(distance / 1000);
                    cooldownDisplay.innerHTML = `<span style="color: #666;">You can resend in ${seconds}s</span>`;
                }, 1000);
            } else {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
        })
        .catch(error => {
            console.error('Resend error:', error);
            resendBtn.disabled = false;
            resendBtn.style.opacity = '1';
            resendBtn.style.cursor = 'pointer';
            resendBtn.textContent = originalText;
            cooldownDisplay.innerHTML = '<span style="color: #c33; font-weight: bold;">✗ Error sending code. Please try again.</span>';
            alert('Failed to resend code. Error: ' + error.message);
        });
    }

    async function handleFirebaseSignup(event) {
        event.preventDefault();
        
        // Check if firebaseSignupHandler is loaded
        if (!window.firebaseSignupHandler) {
            console.error('Firebase signup handler not loaded yet');
            alert('Firebase is loading. Please try again in a moment.');
            return;
        }
        
        const email = document.querySelector('input[name="email"]').value;
        const password1 = document.querySelector('input[name="password1"]').value;
        const password2 = document.querySelector('input[name="password2"]').value;
        const errorList = document.querySelector('.errorlist');
        
        // Validate passwords match
        if (password1 !== password2) {
            if (errorList) {
                errorList.innerHTML = '<li>Passwords do not match.</li>';
            }
            return;
        }

        // Show loading state
        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Creating account...';

        try {
            const result = await window.firebaseSignupHandler.signup(email, password1);
            
            if (result.success) {
                // Clear errors
                if (errorList) errorList.innerHTML = '';
                
                // Show verification message
                const messageDiv = document.querySelector('.signup_leftbody');
                const verificationDiv = document.createElement('div');
                verificationDiv.style.cssText = 'background: #e8f5e9; border: 1px solid #4caf50; border-radius: 8px; padding: 1rem; margin: 1rem 0; color: #2e7d32;';
                verificationDiv.innerHTML = `
                    <h4 style="margin-top: 0;">Account Created!</h4>
                    <p>A verification email has been sent to <strong>${email}</strong></p>
                    <p>Please click the link in the email to verify your account before signing in.</p>
                    <p><small>Check your spam folder if you don't see the email.</small></p>
                `;
                messageDiv.appendChild(verificationDiv);
                
                // Reset form
                event.target.reset();
                
                // Redirect after 3 seconds
                setTimeout(() => {
                    window.location.href = '{% url "login" %}';
                }, 3000);
            } else {
                // Show error
                if (errorList) {
                    errorList.innerHTML = `<li>${result.message}</li>`;
                } else {
                    const newErrorList = document.createElement('ul');
                    newErrorList.className = 'errorlist';
                    newErrorList.innerHTML = `<li>${result.message}</li>`;
                    event.target.parentElement.insertBefore(newErrorList, event.target);
                }
            }
        } catch (error) {
            console.error('Signup error:', error);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    }

    window.handleFirebaseSignup = handleFirebaseSignup;
    window.togglePasswordVisibility = togglePasswordVisibility;
    window.startOTPCountdown = startOTPCountdown;
    window.handleResendClick = handleResendClick;
    
    // Prevent double form submission
    window.disableSubmitButton = function(event) {
        const form = event.target;
        const submitBtn = form.querySelector('button[type="submit"]');
        
        if (submitBtn && !submitBtn.disabled) {
            submitBtn.disabled = true;
            submitBtn.style.opacity = '0.6';
            submitBtn.style.cursor = 'not-allowed';
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Processing...';
            
            // Re-enable after 5 seconds if form submission somehow fails
            setTimeout(() => {
                submitBtn.disabled = false;
                submitBtn.style.opacity = '1';
                submitBtn.style.cursor = 'pointer';
                submitBtn.textContent = originalText;
            }, 5000);
            
            return true; // Allow the actual form submission
        }
        
        // If button is already disabled, prevent the submission
        return false;
    };
    
    console.log('✓ All functions exposed to window:', { handleFirebaseSignup: window.handleFirebaseSignup, togglePasswordVisibility: window.togglePasswordVisibility, startOTPCountdown: window.startOTPCountdown, handleResendClick: window.handleResendClick, disableSubmitButton: window.disableSubmitButton });

    // Start countdown when OTP verification form is shown
    function initializeOTPCountdown() {
        const otpTimer = document.getElementById('otp-timer');
        console.log('initializeOTPCountdown called, otpTimer:', otpTimer);
        
        if (otpTimer) {
            console.log('OTP timer element found, starting countdown...');
            const result = startOTPCountdown();
            console.log('startOTPCountdown result:', result);
            return true;
        }
        return false;
    }

    // Try multiple times to initialize (in case elements load dynamically)
    let initAttempts = 0;
    const initInterval = setInterval(() => {
        initAttempts++;
        console.log(`Initialization attempt ${initAttempts}`);
        
        if (initializeOTPCountdown()) {
            clearInterval(initInterval);
            console.log('OTP countdown initialized successfully');
        }
        
        if (initAttempts >= 20) {
            clearInterval(initInterval);
            console.warn('Could not find OTP timer element after 20 attempts');
        }
    }, 100);

    // Also try immediately on DOMContentLoaded
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOMContentLoaded fired, attempting to initialize OTP');
            initializeOTPCountdown();
        });
    } else {
        console.log('DOM already loaded, attempting to initialize OTP immediately');
        setTimeout(initializeOTPCountdown, 50);
    }
    
    // One more aggressive attempt after a short delay
    setTimeout(() => {
        console.log('Final attempt to initialize OTP timer');
        initializeOTPCountdown();
    }, 500);
</script>

<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
        background: #f5f7fa !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    /* Hide global header/navigation and footer for the signup page */
    header, nav, .navbar, .site-header, .topbar, .main-nav, .navigation, .header, .site-navigation,
    footer, .site-footer, .page-footer, .footer, .footer-wrapper, .bottom-footer { display: none !important; }
    
    /* Home button */
    .signup-home-btn {
        position: fixed;
        left: 24px;
        top: 24px;
        z-index: 1200;
        background: #fff;
        color: #222;
        padding: 10px 16px;
        border-radius: 8px;
        box-shadow: 0 6px 18px rgba(0,0,0,0.12);
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        font-size: 0.95rem;
        transition: all 0.3s ease;
    }
    
    .signup-home-btn:hover {
        box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }
    
    .signuppage {
        padding-top: 0;
        min-height: 120vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
    }
    
    .signup_body {
        display: flex;
        width: 90%;
        max-width: 1000px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.12);
        overflow: hidden;
        min-height: 750px !important;
    }
    
    .signup_left, .signup_right {
        flex: 1;
        padding: 48px 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 750px !important;
    }
    
    .signup_leftbody h2 {
        font-size: 2rem;
        margin-bottom: 32px;
        color: #333;
        font-weight: 700;
    }
    
    .signup_leftbody form {
        width: 100%;
    }
    
    .signup_rightbody h4 {
        font-size: 1.8rem;
        margin-bottom: 20px;
        font-weight: 700;
        color: white;
    }
    
    .signupright_bodyp {
        margin-bottom: 30px;
    }
    
    .signupright_bodyp p {
        font-size: 1rem;
        line-height: 1.6;
        opacity: 1;
        color: white;
    }
    
    .signup_leftbody form {
        width: 100%;
    }
    
    .signup_leftbody form > div {
        margin-bottom: 20px;
    }
    
    .signup_leftbody form > small {
        margin-bottom: 16px;
    }
    
    .password-wrapper {
        position: relative;
        margin-bottom: 0;
        width: 100%;
        display: flex;
        align-items: center;
    }
    
    .password-wrapper input {
        width: 100%;
        padding: 12px 40px 12px 16px;
        border: 1.5px solid #ddd;
        border-radius: 8px;
        font-size: 0.95rem;
        font-family: inherit;
        transition: all 0.3s ease;
        background: white;
        box-sizing: border-box;
        flex: 1;
    }
    
    .password-wrapper input:focus {
        outline: none;
        border-color: #003d99;
        box-shadow: 0 0 0 3px rgba(0, 61, 153, 0.1);
    }
    
    .toggle-password {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        width: 18px;
        height: 18px;
        opacity: 0.6;
        transition: opacity 0.2s;
        flex-shrink: 0;
    }
    
    .toggle-password:hover {
        opacity: 1;
    }
    
    @media (max-width: 768px) {
        .toggle-password {
            width: 16px;
            height: 16px;
            right: 12px;
        }
    }
    
    @media (max-width: 480px) {
        .toggle-password {
            width: 16px;
            height: 16px;
            right: 10px;
            top: 50%;
        }
    }
    
    .signup_leftbody label {
        display: block;
        margin-bottom: 8px;
        color: #555;
        font-weight: 500;
        font-size: 0.95rem;
    }
    
    .form_field {
        position: relative;
        margin-bottom: 20px;
        width: 100%;
        display: flex;
        flex-direction: column;
    }
    
    .form_field input {
        width: 100%;
        padding: 12px 40px 12px 16px;
        border: 1.5px solid #ddd;
        border-radius: 8px;
        font-size: 0.95rem;
        font-family: inherit;
        transition: all 0.3s ease;
        background: white;
        box-sizing: border-box;
    }
    
    .form_field input:focus {
        outline: none;
        border-color: #003d99;
        box-shadow: 0 0 0 3px rgba(0, 61, 153, 0.1);
    }
    
    .form_field input::placeholder {
        color: #999;
    }
    
    .form_field i {
        position: absolute;
        right: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: #666;
        pointer-events: none;
        font-size: 1.1rem;
    }
    
    .password-input-wrapper {
        position: relative;
        margin-bottom: 20px;
    }
    
    .password-input-wrapper input {
        width: 100%;
        padding: 12px 40px 12px 16px;
        border: 1.5px solid #ddd;
        border-radius: 8px;
        font-size: 0.95rem;
        font-family: inherit;
        transition: all 0.3s ease;
    }
    
    .password-input-wrapper input:focus {
        outline: none;
        border-color: #003d99;
        box-shadow: 0 0 0 3px rgba(0, 61, 153, 0.1);
    }
    
    .password-toggle-btn {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        background: transparent !important;
        border: none !important;
        cursor: pointer;
        color: #666 !important;
        font-size: 1.1rem !important;
        padding: 4px 8px !important;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: color 0.2s;
    }
    
    .password-toggle-btn:hover {
        color: #003d99;
    }
    
    .password-toggle-btn i {
        pointer-events: none;
    }
    
    /* OTP Verification styling */
    #otp-timer {
        text-align: center;
        margin-top: 15px;
        margin-bottom: 20px;
        padding: 12px 14px;
        font-size: 0.9rem;
        color: #003d99;
        font-weight: 600;
        background: #f0f4ff;
        border-radius: 6px;
        border-left: 3px solid #003d99;
        display: block !important;
        min-height: 20px;
        visibility: visible !important;
    }
    
    #resend-timer-display {
        text-align: center;
        margin-bottom: 12px;
        padding: 8px 10px;
        font-size: 0.85rem;
        color: #666;
        font-weight: 600;
        background: #f5f5f5;
        border-radius: 4px;
        display: block !important;
        min-height: 16px;
        visibility: visible !important;
    }
    
    .otp-header {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e8e8e8;
    }
    
    .otp-header h3 {
        margin-bottom: 12px;
        font-size: 1.6rem;
        color: #333;
        font-weight: 700;
    }
    
    .otp-header p {
        color: #666;
        font-size: 0.95rem;
        margin-bottom: 0;
        line-height: 1.5;
    }
    
    .otp-messages {
        margin-bottom: 20px;
    }
    
    .otp-message {
        padding: 12px 14px;
        border-radius: 6px;
        border-left: 4px solid;
        margin-bottom: 16px;
        font-size: 0.9rem;
        line-height: 1.5;
    }
    
    .otp-message.success {
        background-color: #e8f5e9;
        color: #2e7d32;
        border-left-color: #4caf50;
    }
    
    .otp-message.error {
        background-color: #fee;
        color: #c33;
        border-left-color: #c33;
    }
    
    .otp-label {
        display: block;
        margin-bottom: 12px;
        color: #333;
        font-weight: 700;
        font-size: 1rem;
    }
    
    .verification_code {
        width: 100%;
        padding: 16px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 1.3rem;
        letter-spacing: 6px;
        text-align: center;
        margin-bottom: 24px;
        font-family: 'Courier New', monospace;
        font-weight: 600;
        transition: all 0.3s ease;
        background: white;
        box-sizing: border-box;
    }
    
    .verification_code:focus {
        outline: none;
        border-color: #003d99;
        box-shadow: 0 0 0 4px rgba(0, 61, 153, 0.15);
        background: #f8fbff;
    }
    
    .verification_code::placeholder {
        opacity: 0.3;
        letter-spacing: 6px;
    }
    
    /* Resend OTP Section Styling */
    .resend-section {
        display: block !important;
        width: 100% !important;
        clear: both;
        margin-top: 32px;
        padding: 16px;
        background: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-sizing: border-box;
    }
    
    .resend-section * {
        display: block !important;
        width: 100% !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
    }
    
    .resend-section h4 {
        text-align: center;
        margin: 0 0 12px 0 !important;
        color: #333;
        font-size: 0.85rem;
        font-weight: 600;
        line-height: 1.4;
    }
    
    .resend-section form {
        margin: 0 0 8px 0 !important;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
    }
    
    .resend-section form input[type="hidden"] {
        display: none !important;
    }
    
    #resend-btn {
        padding: 10px 16px;
        background: linear-gradient(135deg, #666 0%, #555 100%);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.4px;
        box-sizing: border-box;
    }
    
    #resend-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 102, 102, 0.2);
    }
    
    #resend-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .resend-cooldown-text {
        margin-top: 8px;
        margin-bottom: 12px;
        padding: 8px 10px;
        font-size: 0.85rem;
        color: #666;
        text-align: center;
        background: #f5f5f5;
        border-radius: 4px;
        display: block !important;
        min-height: 18px;
        visibility: visible !important;
    }
    
    /* Mobile Responsive - OTP + resend layout */
    @media (max-width: 768px) {
        .signuppage {
            padding: 24px 12px;
            align-items: flex-start;
        }

        .signup_body {
            flex-direction: column;
            width: 100%;
            max-width: 420px;
            margin: 0 auto;
            border-radius: 14px;
        }

        .signup_left,
        .signup_right {
            padding: 28px 20px;
            min-height: auto !important;
        }

        .signup_leftbody h2 {
            text-align: center;
            font-size: 1.6rem;
            margin-bottom: 20px;
        }

        .otp-header {
            text-align: center;
            margin-bottom: 18px;
            padding-bottom: 14px;
        }
        
        .otp-header h3 {
            font-size: 1.35rem !important;
        }
        
        .otp-header p {
            font-size: 0.9rem !important;
        }
        
        #otp-timer {
            font-size: 0.75rem !important;
            margin-top: 8px !important;
        }
        
        .verification_code {
            font-size: 1rem !important;
        }

        .resend-section {
            padding: 14px 12px !important;
            text-align: center;
        }
        
        .resend-section h4 {
            font-size: 0.9rem !important;
            text-align: center;
        }

        .resend-section form {
            width: 100%;
            justify-content: center;
            display: flex;
            text-align: center;
            align-items: center;
        }
        
        #resend-btn {
            padding: 9px 24px !important;
            font-size: 0.8rem !important;
            width: auto !important;
            margin: 0 auto !important;
            display: inline-block !important;
        }

        .resend-cooldown-text {
            font-size: 0.75rem;
        }
    }
    
    @media (max-width: 480px) {
        .signuppage {
            padding: 18px 8px;
        }

        .signup_body {
            max-width: 360px;
        }
        
        .signup_left,
        .signup_right {
            padding: 22px 16px;
        }

        .signup_leftbody h2 {
            font-size: 1.4rem;
        }
        
        .resend-section form {
            width: 100%;
            justify-content: center;
            display: flex;
            text-align: center;
            align-items: center;
        }
        
        #resend-btn {
            padding: 8px 12px !important;
            font-size: 0.7rem !important;
            width: auto !important;
            margin: 0 auto !important;
            display: inline-block !important;
        }
    }
    
    /* Error message styling */
    .errorlist {
        list-style: none;
        padding: 0;
        margin: 0 0 20px 0;
    }
    
    .errorlist li {
        background-color: #fee;
        color: #c33;
        padding: 10px 14px;
        border-radius: 6px;
        border-left: 4px solid #c33;
        margin-bottom: 8px;
        font-size: 0.9rem;
        line-height: 1.5;
    }
    
    .signup_leftbody small {
        display: block;
        color: #c33;
        font-size: 0.85rem;
        margin-top: 8px;
        line-height: 1.4;
        width: 100%;
        text-align: left;
    }
    
    /* Button styling */
    button[type="submit"] {
        width: 100%;
        padding: 11px 20px;
        background: linear-gradient(135deg, #001a4d 0%, #003d99 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 8px;
        margin-bottom: 16px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-sizing: border-box;
    }
    
    button[type="submit"]:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 61, 153, 0.3);
    }
    
    button[type="submit"]:active {
        transform: translateY(0);
    }
    
    button[type="submit"]:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    /* Right side styling */
    .signup_rightbody h4 {
        font-size: 1.8rem;
        margin-bottom: 20px;
        font-weight: 700;
    }
    
    .signupright_bodyp {
        margin-bottom: 30px;
    }
    
    .signupright_bodyp p {
        font-size: 1rem;
        line-height: 1.6;
        opacity: 0.95;
    }
    
    .signup_rightbody a {
        display: inline-block;
        padding: 12px 40px;
        background: #003d99;
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .signup_rightbody a:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 61, 153, 0.3);
    }
    
    /* Mobile Responsive */
    @media (max-width: 768px) {
        .signup-home-btn {
            left: 14px;
            top: 14px;
            padding: 8px 12px;
            font-size: 0.85rem;
        }
        
        .signup_body {
            flex-direction: column;
            width: 95%;
        }
        
        .signup_left, .signup_right {
            padding: 36px 24px;
            min-height: 650px;
        }
        
        .signup_leftbody h2 {
            font-size: 1.6rem;
            margin-bottom: 24px;
        }
        
        .signup_rightbody {
            padding: 30px 24px;
        }
        
        .signup_rightbody h4 {
            font-size: 1.4rem;
        }
        
        .form_field input, .password-input-wrapper input, .password-wrapper input {
            width: 100% !important;
            padding: 11px 36px 11px 14px !important;
            font-size: 0.9rem !important;
            box-sizing: border-box !important;
        }
        
        .toggle-password {
            width: 16px !important;
            height: 16px !important;
            right: 12px !important;
        }
        
        .errorlist li {
            font-size: 0.8rem;
            padding: 8px 12px;
        }
        
        button[type="submit"] {
            padding: 11px 20px;
            font-size: 0.95rem;
        }
    }
    
    @media (max-width: 480px) {
        .signup-home-btn {
            left: 10px;
            top: 10px;
            padding: 6px 10px;
            font-size: 0.75rem;
        }
        
        .signup_left, .signup_right {
            padding: 24px 16px;
            min-height: auto;
        }
        
        .signup_leftbody h2 {
            font-size: 1.4rem;
            margin-bottom: 20px;
        }
        
        .signup_leftbody h3 {
            font-size: 1.2rem;
        }
        
        .form_field input, .password-input-wrapper input, .password-wrapper input {
            width: 100% !important;
            padding: 10px 36px 10px 12px !important;
            font-size: 0.85rem !important;
            box-sizing: border-box !important;
        }
        
        .toggle-password {
            width: 14px !important;
            height: 14px !important;
            right: 10px !important;
        }
        
        .form_field {
            margin-bottom: 16px;
        }
        
        .signup_rightbody {
            padding: 24px 16px;
        }
        
        .signup_rightbody h4 {
            font-size: 1.2rem;
            margin-bottom: 16px;
        }
        
        .signupright_bodyp p {
            font-size: 0.9rem;
        }
        
        .signup_rightbody a {
            padding: 10px 32px;
            font-size: 0.85rem;
        }
    }
</style>

<a class="signup-home-btn" href="{% url 'product' %}"><i class="fa-solid fa-home"></i> Home</a>

<div class="signuppage">
    <div class="signup_body">
        <div class="signup_left">
            <div class="signup_leftbody">
                <h2>Sign Up</h2>
                <form method="POST" id="firebase-signup-form" onsubmit="disableSubmitButton(event)">
                    {% csrf_token %}
                        {% if otp_code %}
                               <h3>Verify Your Email</h3>
                        <div class="otp-header">
                     
                            <p>Enter the 6-digit code sent to <strong>{{ form.instance.email }}</strong></p>
                        </div>
                        <div id="otp-timer"></div>

                        {% if messages %}
                        <div class="otp-messages">
                            {% for message in messages %}
                                <div class="otp-message {% if message.tags %}{% if 'error' in message.tags or 'warning' in message.tags %}error{% else %}success{% endif %}{% else %}success{% endif %}">
                                    {{ message }}
                                </div>
                            {% endfor %}
                        </div>
                        {% endif %}

                        <label for="otp_code" class="otp-label">Verification Code</label>
                        <div class="form_field">
                            <input class="verification_code" type="text" name="otp_code" placeholder="000000" maxlength="6" autocomplete="off" required>
                        </div>
                        <input type="hidden" name="username" value="{{ form.instance.username }}">
                        <button type="submit">Verify OTP</button>
                        
                        <!-- Debug info -->
                        <div style="margin-top: 15px; font-size: 12px; color: #999; text-align: center;">
                            <p>Username: {{ form.instance.username }}</p>
                            <p>Email: {{ form.instance.email }}</p>
                        </div>
                        
                        {% else %}
                        {% for field in form %}
                            {% if field.name == 'email' %}
                                <div class="form_field">
                                    {{ field }}
                                    <i class="fa-solid fa-envelope"></i>
                                    {% if field.errors %}
                                        <small>
                                            {% for error in field.errors %}
                                                {{ error }}<br>
                                            {% endfor %}
                                        </small>
                                    {% endif %}
                                </div>
                            {% elif field.name == 'contact' %}
                                <div class="form_field">
                                    {{ field }}
                                    <i class="fa-solid fa-phone"></i>
                                    {% if field.errors %}
                                        <small>
                                            {% for error in field.errors %}
                                                {{ error }}<br>
                                            {% endfor %}
                                        </small>
                                    {% endif %}
                                </div>
                                <script>
                                    document.addEventListener('DOMContentLoaded', function() {
                                        const contactInput = document.querySelector('input[name="contact"]');
                                        if (contactInput) {
                                            contactInput.type = 'tel';
                                            contactInput.pattern = '[0-9]*';
                                            contactInput.inputMode = 'numeric';
                                            contactInput.maxLength = '15';
                                            
                                            // Prevent non-numeric input
                                            contactInput.addEventListener('input', function(e) {
                                                this.value = this.value.replace(/[^0-9]/g, '');
                                            });
                                            
                                            // Prevent non-numeric paste
                                            contactInput.addEventListener('paste', function(e) {
                                                e.preventDefault();
                                                const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                                                const numericOnly = pastedText.replace(/[^0-9]/g, '');
                                                this.value = numericOnly;
                                            });
                                        }
                                    });
                                </script>
                            {% elif field.name == 'username' %}
                                <div class="form_field">
                                    {{ field }}
                                    <i class="fa-solid fa-user"></i>
                                    {% if field.errors %}
                                        <small>
                                            {% for error in field.errors %}
                                                {{ error }}<br>
                                            {% endfor %}
                                        </small>
                                    {% endif %}
                                </div>
                            {% elif field.name == 'password1' or field.name == 'password2' %}
                                <div class="form_field">
                                    <div class="password-wrapper">
                                        {{ field }}
                                        <img src="{% static 'images/icon/password-hide.png' %}" class="toggle-password" id="togglePassword{{ forloop.counter }}" alt="Show Password">
                                    </div>
                                    {% if field.errors %}
                                        <small>
                                            {% for error in field.errors %}
                                                {{ error }}<br>
                                            {% endfor %}
                                        </small>
                                    {% endif %}
                                </div>
                            {% else %}
                                <div class="form_field">
                                    {{ field }}
                                    {% if field.errors %}
                                        <small>
                                            {% for error in field.errors %}
                                                {{ error }}<br>
                                            {% endfor %}
                                        </small>
                                    {% endif %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    <button type="submit">Sign up</button>
                </form>
                <script>
                    // Handle password visibility toggle for all password fields
                    document.querySelectorAll('.toggle-password').forEach(toggle => {
                        toggle.addEventListener('click', function() {
                            const wrapper = this.parentElement;
                            const input = wrapper.querySelector('input');
                            if (input) {
                                if (input.type === 'password') {
                                    input.type = 'text';
                                    this.src = "{% static 'images/icon/password-visible.png' %}";
                                } else {
                                    input.type = 'password';
                                    this.src = "{% static 'images/icon/password-hide.png' %}";
                                }
                            }
                        });
                    });
                </script>
                {% endif %}
                
                <!-- Resend OTP Section - Only show after delay on fresh OTP -->
                {% if otp_code %}
                <div class="resend-section" id="resend-section" style="display: {% if is_fresh_otp %}none{% else %}block{% endif %};">
                    <h4>⏱ Didn't receive the code?</h4>
                    <div id="resend-cooldown" class="resend-cooldown-text"></div>
                    <form method="POST" action="{% url 'resend-otp' %}" id="resend-otp-form">
                        {% csrf_token %}
                        <input type="hidden" name="otp_email" value="{{ form.instance.email }}">
                        <button type="button" id="resend-btn" onclick="handleResendClick(event)">Request New Code</button>
                    </form>
                </div>
                {% if is_fresh_otp %}
                <script>
                    // Show resend section after 60 seconds on fresh OTP to prevent accidental double OTP
                    console.log('Fresh OTP detected, hiding resend for 60 seconds');
                    setTimeout(() => {
                        const resendSection = document.getElementById('resend-section');
                        if (resendSection) {
                            resendSection.style.display = 'block';
                            console.log('Resend section shown after 60 seconds');
                        }
                    }, 60000);
                </script>
                {% endif %}
                {% endif %}
            </div>
        </div>
        <div class="signup_right">
            <div class="signup_rightbody">
                <h4>Welcome Back!</h4>
                <div class="signupright_bodyp">
                    <p>Sign in to manage your appointments and device listings.</p>
                </div>
                <a href="{% url 'login' %}">Sign In</a>
            </div>
        </div>
    </div>
</div>

{% endblock content %}